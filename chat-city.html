<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat Rooms - Live in Oz</title>
    <link rel="stylesheet" href="global.css" />
    <link rel="stylesheet" href="html/salon-list.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="auth-php.js"></script>
    <style>
      .breadcrumb {
        margin-bottom: 20px;
        font-size: 0.9em;
      }

      .breadcrumb a {
        color: #00eeff;
        text-decoration: none;
      }

      .breadcrumb a:hover {
        text-decoration: underline;
      }

      .breadcrumb span {
        color: #888;
      }

      .rooms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmin(250px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .room-card {
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #00eeff;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .room-card:hover {
        background: rgba(0, 238, 255, 0.1);
        transform: translateY(-3px);
      }

      .room-name {
        font-size: 1.2em;
        color: #00eeff;
        margin-bottom: 8px;
      }

      .room-type {
        color: #888;
        font-size: 0.8em;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .room-card.general {
        border-color: #00eeff;
      }
      .room-card.help {
        border-color: #00ff88;
      }
      .room-card.housing {
        border-color: #ffaa00;
      }
      .room-card.jobs {
        border-color: #ff4444;
      }
      .room-card.buy_sell {
        border-color: #aa44ff;
      }
      .room-card.suggestions {
        border-color: #44aaff;
      }
      .room-card.off_topic {
        border-color: #ff66aa;
      }
      .room-card.more {
        border-color: #ffaa44;
      }

      .language-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #00eeff;
        border-radius: 25px;
        padding: 5px;
        cursor: pointer;
      }

      .lang-btn {
        background: none;
        border: none;
        color: #888;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-family: "Courier New", monospace;
      }

      .lang-btn.active {
        background: #00eeff;
        color: #000;
      }

      /* New styles for flag display */
      .flag-container {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 16px;
        margin-right: 8px;
        vertical-align: middle;
      }

      .flag-container svg {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body class="chat-rooms-page">
    <!-- Navigation bar will be loaded here -->
    <div id="navbar-placeholder"></div>

    <!-- Main content with salon-list design -->
    <div class="background" id="mainContent" style="display: none">
      <header class="chat-rooms-header">
          <h1 class="title" id="pageTitle">Chat Rooms</h1>
          <div class="chips">
            <div class="chip chip-city">
              <span id="breadcrumb-state">State</span>
            </div>
            <div class="chip chip-lang">
              <span>EN | ES</span>
            </div>
            <div class="chip chip-back">
              <span>‚Üê Back</span>
            </div>
          </div>
          <div class="search-wrap">
            <input
              type="text"
              class="search-input"
              placeholder="Search rooms"
              id="searchInput"
            />
          </div>
          <div class="tabs">
            <div class="tab active" data-cat="all">All</div>
            <div class="tab" data-cat="social">Social</div>
            <div class="tab" data-cat="daily">Daily Life</div>
            <div class="tab" data-cat="work">Work & Money</div>
            <div class="tab" data-cat="fitness">Fitness</div>
            <div class="tab" data-cat="hobbies">Hobbies</div>
          </div>
        </header>
        <div class="container">
          <main class="grid" id="roomsContainer">
            <!-- Rooms will be loaded here -->
          </main>
        </div>
      </div>
    </div>

    <script>
      let currentLanguage = localStorage.getItem("chat_language") || "en";
      let currentState = "";
      let currentCity = "";
      let allRooms = [];
      let currentCategory = "all";
      let currentSearch = "";

      // Colors for fallback (old rooms without DB colors)
      const fallbackColors = {
        general: "#00e5ff",
        help: "#ff3fd8",
        housing: "#ff8a5c",
        jobs: "#00ffb0",
        buy_sell: "#5599ff",
        suggestions: "#ffa03c",
        off_topic: "#ff6b8b",
        more: "#ffaa44",
      };

      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      currentState = urlParams.get("state") || "";

      // Country flag SVG mapping
      const countryFlags = {
        Argentinians: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="22" height="16" fill="#74ACDF"/><rect width="22" height="8" y="4" fill="#FFF"/><path d="M11,8 C11,8.552 10.552,9 10,9 C9.448,9 9,8.552 9,8 C9,7.448 9.448,7 10,7 C10.552,7 11,7.448 11,8 Z" fill="#F6B40E"/></svg>`,
        Argentinos: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="22" height="16" fill="#74ACDF"/><rect width="22" height="8" y="4" fill="#FFF"/><path d="M11,8 C11,8.552 10.552,9 10,9 C9.448,9 9,8.552 9,8 C9,7.448 9.448,7 10,7 C10.552,7 11,7.448 11,8 Z" fill="#F6B40E"/></svg>`,
        Mexicans: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="7.333" height="16" fill="#006847"/><rect width="7.333" height="16" x="7.333" fill="#FFF"/><rect width="7.333" height="16" x="14.667" fill="#CE1126"/></svg>`,
        Mexicanos: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="7.333" height="16" fill="#006847"/><rect width="7.333" height="16" x="7.333" fill="#FFF"/><rect width="7.333" height="16" x="14.667" fill="#CE1126"/></svg>`,
        Colombians: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="22" height="16" fill="#FCD116"/><rect width="22" height="8" y="8" fill="#003893"/><rect width="22" height="4" y="12" fill="#CE1126"/></svg>`,
        Colombianos: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="22" height="16" fill="#FCD116"/><rect width="22" height="8" y="8" fill="#003893"/><rect width="22" height="4" y="12" fill="#CE1126"/></svg>`,
        Peruvians: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="7.333" height="16" fill="#D91023"/><rect width="7.333" height="16" x="7.333" fill="#FFF"/><rect width="7.333" height="16" x="14.667" fill="#D91023"/></svg>`,
        Peruanos: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="7.333" height="16" fill="#D91023"/><rect width="7.333" height="16" x="7.333" fill="#FFF"/><rect width="7.333" height="16" x="14.667" fill="#D91023"/></svg>`,
        Spanish: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="22" height="16" fill="#AA151B"/><rect width="22" height="8" y="4" fill="#F1BF00"/></svg>`,
        Espa√±oles: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="22" height="16" fill="#AA151B"/><rect width="22" height="8" y="4" fill="#F1BF00"/></svg>`,
        Brazilians: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="22" height="16" fill="#009739"/><polygon fill="#FEDD00" points="11,2 19,8 11,14 3,8"></polygon><circle cx="11" cy="8" r="3" fill="#009739"/></svg>`,
        Brasile√±os: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="22" height="16" fill="#009739"/><polygon fill="#FEDD00" points="11,2 19,8 11,14 3,8"></polygon><circle cx="11" cy="8" r="3" fill="#009739"/></svg>`,
        Chileans: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="22" height="16" fill="#D52B1E"/><rect width="11" height="8" fill="#FFF"/><rect width="5.5" height="8" fill="#0039A6"/><path d="M5.5,4 C5.5,4.552 5.052,5 4.5,5 C3.948,5 3.5,4.552 3.5,4 C3.5,3.448 3.948,3 4.5,3 C5.052,3 5.5,3.448 5.5,4 Z" fill="#FFF"/></svg>`,
        Chilenos: `<svg width="22" height="16" viewBox="0 0 22 16"><rect width="22" height="16" fill="#D52B1E"/><rect width="11" height="8" fill="#FFF"/><rect width="5.5" height="8" fill="#0039A6"/><path d="M5.5,4 C5.5,4.552 5.052,5 4.5,5 C3.948,5 3.5,4.552 3.5,4 C3.5,3.448 3.948,3 4.5,3 C5.052,3 5.5,3.448 5.5,4 Z" fill="#FFF"/></svg>`,
      };

      // Translation mappings
      const roomTranslations = {
        // Shopping & Daily Life
        "Shopping & Deals": { es: "Compras y Ofertas" },
        "Lost & Found": { es: "Objetos Perdidos" },
        "New arrivals": { es: "Reci√©n llegados" },

        // Fitness & Sports
        "Gym & Fitness": { es: "Gimnasio y Fitness" },
        "Running & Marathons": { es: "Running y Maratones" },
        "Calisthenics / Streets": { es: "Calistenia / Calles" },
        "Tennis / Padel": { es: "Tenis / P√°del" },
        Surf: { es: "Surf" },

        // Hobbies
        "Gamers & Tech": { es: "Jugadores y Tecnolog√≠a" },
        "Movies & Series": { es: "Pel√≠culas y Series" },
        Photography: { es: "Fotograf√≠a" },
        "Art & Design": { es: "Arte y Dise√±o" },
        Weed: { es: "Marihuana" },

        // General - Basic Rooms
        General: { es: "General" },
        "General Chat": { es: "Chat General" },
        "Help & Support": { es: "Ayuda y Soporte" },
        Housing: { es: "Vivienda" },
        Jobs: { es: "Trabajos" },
        Entrepreneur: { es: "Emprendedores" },
        "Buy & Sell": { es: "Compra y Venta" },
        Suggestions: { es: "Sugerencias" },
        "Off-Topic": { es: "Fuera de Tema" },
        "More Communities": { es: "M√°s Comunidades" },
        "Visas and Docs": { es: "Visas y Documentos" },
        "Rides and Transport": { es: "Viajes y Transporte" },

        // Social & Meetups
        Football: { es: "F√∫tbol" },
        Meetups: { es: "Reuniones" },
        "BBQ Meetups": { es: "BBQ Reuniones" },
        "Mate lovers": { es: "Amantes del Mate" },
        "Let's go to the beach": { es: "Vamos a la playa" },
        "Music & Dance": { es: "M√∫sica y Baile" },
        "Latinas United": { es: "Latinas Unidas" },

        // Countries
        Argentinians: { es: "Argentinos" },
        Mexicans: { es: "Mexicanos" },
        Colombians: { es: "Colombianos" },
        Peruvians: { es: "Peruanos" },
        Spanish: { es: "Spanish" },
        Brazilians: { es: "Brasile√±os" },
        Chileans: { es: "Chilenos" },
      };

      // Reverse lookup for Spanish to English
      const reverseTranslations = {};
      Object.keys(roomTranslations).forEach((en) => {
        const es = roomTranslations[en].es;
        // Don't create reverse translation for Spanish (keeps it same in both languages)
        if (es !== "Spanish") {
          reverseTranslations[es] = en;
        }
      });

      // Translation function
      function translateRoomName(roomName) {
        // First, replace Spaniards with Spanish
        if (roomName === "Spaniards") {
          roomName = "Spanish";
        }

        if (currentLanguage === "es") {
          // English to Spanish
          return roomTranslations[roomName]?.es || roomName;
        } else {
          // Spanish to English
          return reverseTranslations[roomName] || roomName;
        }
      }

      // Get country flag SVG for a room name
      function getCountryFlag(roomName) {
        for (const country in countryFlags) {
          if (roomName.includes(country)) {
            return countryFlags[country];
          }
        }
        return null;
      }

      // Check authentication on page load
      document.addEventListener("DOMContentLoaded", function () {
        if (!currentState) {
          window.location.href = "chat-directory.html";
          return;
        }

        checkAuthentication();
        setupEventListeners();
        updateLanguage(currentLanguage);
      });

      async function checkAuthentication() {
        try {
          const authenticated = await isAuthenticated();

          if (authenticated) {
            await fetch("init_user_prefs.php");
            document.getElementById("mainContent").style.display = "block";
            await loadStateInfo();
            loadRooms();
          } else {
            document.getElementById("loginRequired").style.display = "block";
            localStorage.setItem("redirectAfterLogin", window.location.href);
          }
        } catch (error) {
          console.error("Authentication check error:", error);
          document.getElementById("loginRequired").style.display = "block";
        }
      }

      function setupEventListeners() {
        document.querySelector(".chip-lang").addEventListener("click", () => {
          const newLang = currentLanguage === "en" ? "es" : "en";
          setLanguage(newLang);
        });

        document.querySelector(".chip-back").addEventListener("click", () => {
          window.location.href = "chat-directory.html";
        });

        document
          .getElementById("searchInput")
          .addEventListener("input", (e) => {
            currentSearch = e.target.value.toLowerCase();
            filterAndDisplayRooms();
          });

        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            setActiveCategory(tab.dataset.cat);
          });
        });
      }

      async function setLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem("chat_language", lang);
        updateLanguage(lang);

        try {
          await fetch("update_language.php", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `language=${lang}`,
          });
        } catch (error) {
          console.error("Failed to update language preference:", error);
        }

        await loadStateInfo();
        filterAndDisplayRooms(); // Just re-display, don't reload from server
      }

      function updateLanguage(lang) {
        const langChip = document.querySelector(".chip-lang span");
        langChip.textContent = lang === "en" ? "EN | ES" : "ES | EN";

        const backChip = document.querySelector(".chip-back span");
        backChip.textContent = lang === "en" ? "‚Üê Back" : "‚Üê Volver";

        const searchInput = document.getElementById("searchInput");
        searchInput.placeholder =
          lang === "en" ? "Search rooms" : "Buscar salas";

        const titles = {
          en: { title: "Chat Rooms" },
          es: { title: "Salas de Chat" },
        };

        document.getElementById("pageTitle").textContent = titles[lang].title;

        const tabLabels = {
          en: {
            all: "All",
            social: "Social",
            daily: "Daily Life",
            work: "Work & Money",
            fitness: "Fitness",
            hobbies: "Hobbies",
          },
          es: {
            all: "Todas",
            social: "Social",
            daily: "Vida diaria",
            work: "Trabajo y dinero",
            fitness: "Fitness",
            hobbies: "Hobbies",
          },
        };

        document.querySelectorAll(".tab").forEach((tab) => {
          const cat = tab.dataset.cat;
          tab.textContent = tabLabels[lang][cat];
        });
      }

      function setActiveCategory(newCat) {
        currentCategory = newCat;
        document.querySelectorAll(".tab").forEach((tab) => {
          if (tab.dataset.cat === newCat) {
            tab.classList.add("active");
          } else {
            tab.classList.remove("active");
          }
        });
        filterAndDisplayRooms();
      }

      async function loadStateInfo() {
        try {
          const response = await fetch(`states.php?lang=${currentLanguage}`);
          const data = await response.json();

          if (data.success) {
            const state = data.states.find((s) => s.code === currentState);
            if (state) {
              currentCity = state.main_city;
              document.getElementById("breadcrumb-state").textContent =
                state.name;
              document.getElementById("pageTitle").textContent =
                (currentLanguage === "es"
                  ? "Salas de Chat - "
                  : "Chat Rooms - ") + state.name;
            }
          }
        } catch (error) {
          console.error("Error loading state info:", error);
        }
      }

      async function loadRooms() {
        if (!currentState || !currentCity) return;

        try {
          const response = await fetch(
            `chat_rooms.php?state=${currentState}&city=${currentCity}&lang=${currentLanguage}`
          );
          const data = await response.json();

          if (data.success) {
            allRooms = data.rooms;
            filterAndDisplayRooms();
          } else {
            console.error("Failed to load rooms:", data.message);
            document.getElementById("roomsContainer").innerHTML =
              "<p>Failed to load rooms. Please try again.</p>";
          }
        } catch (error) {
          console.error("Error loading rooms:", error);
          document.getElementById("roomsContainer").innerHTML =
            "<p>Error loading rooms. Please check your connection.</p>";
        }
      }

      function filterAndDisplayRooms() {
        let filteredRooms = allRooms;

        if (currentCategory !== "all") {
          const categoryMapping = {
            social: ["general", "off_topic", "more"],
            daily: ["housing", "daily_static"],
            work: ["jobs", "buy_sell"],
            fitness: ["fitness_static"],
            hobbies: ["hobbies_static"],
          };

          filteredRooms = filteredRooms.filter((room) =>
            categoryMapping[currentCategory].includes(room.type)
          );
        }

        if (currentSearch) {
          filteredRooms = filteredRooms.filter((room) =>
            room.name.toLowerCase().includes(currentSearch)
          );
        }

        displayRooms(filteredRooms);
      }

      function displayRooms(rooms) {
        const container = document.getElementById("roomsContainer");
        container.innerHTML = "";

        const fallbackEmojis = {
          general: "üí¨",
          help: "üÜò",
          housing: "üè†",
          jobs: "üíº",
          buy_sell: "üõí",
          suggestions: "üí°",
          off_topic: "üé≠",
          more: "üéâ",
          daily_static: "üìã",
          fitness_static: "üèãÔ∏è",
          hobbies_static: "üéÆ",
          work: "üí°",
        };

        rooms.forEach((room) => {
          const card = document.createElement("div");
          card.className = `card ${room.type}`;

          // TRANSLATE THE ROOM NAME HERE
          const translatedName = translateRoomName(room.name);

          const countryFlag = getCountryFlag(translatedName);
          const chosenEmoji = countryFlag
            ? `<div class="flag-container">${countryFlag}</div>`
            : room.emoji || fallbackEmojis[room.type] || "üí¨";

          const chosenColor =
            room.color || fallbackColors[room.type] || "#00e5ff";

          card.style.color = chosenColor;
          card.style.borderColor = chosenColor;
          card.onclick = () => enterRoom(room.identifier);

          card.innerHTML = `
            <div class="card-title">
              ${chosenEmoji}
              <span>${translatedName}</span>
            </div>
          `;

          container.appendChild(card);
        });
      }

      function enterRoom(roomName) {
        window.location.href = `general-chat.html?state=${currentState}&city=${currentCity}&room=${encodeURIComponent(
          roomName
        )}`;
      }
    </script>

    <script src="nav-loader.js"></script>
  </body>
</html>
